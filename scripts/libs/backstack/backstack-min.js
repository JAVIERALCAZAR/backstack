(function(a,b){typeof exports!="undefined"?b(a,exports,require("underscore"),require("jquery"),require("Backbone")):typeof define=="function"&&define.amd?define(["underscore","jquery","Backbone","exports"],function(c,d,e,f){a.BackStack=b(a,f,c,d,e)}):a.BackStack=b(a,{},a._,a.jQuery||a.Zepto||a.ender,a.Backbone)})(this,function(a,b,c,d,e){var f,g,h;return function(a){function j(a,b){if(a&&a.charAt(0)==="."&&b){b=b.split("/"),b=b.slice(0,b.length-1),a=b.concat(a.split("/"));var c,d;for(c=0;d=a[c];c++)if(d===".")a.splice(c,1),c-=1;else if(d==="..")if(c!==1||a[2]!==".."&&a[0]!=="..")c>0&&(a.splice(c-1,2),c-=2);else break;a=a.join("/")}return a}function k(b,c){return function(){return i.apply(a,d.call(arguments,0).concat([b,c]))}}function l(a){return function(b){return j(b,a)}}function m(a){return function(c){b[a]=c}}function n(d){if(c.hasOwnProperty(d)){var f=c[d];delete c[d],e.apply(a,f)}return b[d]}function o(a,b){var c,d,e=a.indexOf("!");return e!==-1?(c=j(a.slice(0,e),b),a=a.slice(e+1),d=n(c),d&&d.normalize?a=d.normalize(a,l(b)):a=j(a,b)):a=j(a,b),{f:c?c+"!"+a:a,n:a,p:d}}var b={},c={},d=[].slice,e,i;if(typeof h=="function")return;e=function(d,e,f,g){var h=[],i,j,l,p,q,r;g||(g=d);if(typeof f=="function"){!e.length&&f.length&&(e=["require","exports","module"]);for(p=0;p<e.length;p++){r=o(e[p],g),l=r.f;if(l==="require")h[p]=k(d);else if(l==="exports")h[p]=b[d]={},i=!0;else if(l==="module")j=h[p]={id:d,uri:"",exports:b[d]};else if(b.hasOwnProperty(l)||c.hasOwnProperty(l))h[p]=n(l);else if(r.p)r.p.load(r.n,k(g,!0),m(l),{}),h[p]=b[l];else throw d+" missing "+l}q=f.apply(b[d],h),d&&(j&&j.exports!==a?b[d]=j.exports:i||(b[d]=q))}else d&&(b[d]=f)},f=i=function(b,c,d,f){return typeof b=="string"?n(o(b,c).f):(b.splice||(c.splice?(b=c,c=arguments[2]):b=[]),f?e(a,b,c,d):setTimeout(function(){e(a,b,c,d)},15),i)},i.config=function(){return i},g||(g=i),h=function(a,b,d){b.splice||(d=b,b=[]),h.unordered?c[a]=[a,b,d]:e(a,b,d)},h.amd={jQuery:!0}}(),h("almond",function(){}),h("effects/vendorPrefix",[],function(){var a,b=/^(Moz|Webkit|Khtml|O|ms|Icab)(?=[A-Z])/,c=document.getElementsByTagName("script")[0];if("WebkitOpacity"in c.style)a="Webkit";else if("KhtmlOpacity"in c.style)a="Khtml";else for(var d in c.style)if(b.test(d)){a=d.match(b)[0];break}return a.toLowerCase()||""}),h("effects/Effect",["effects/vendorPrefix"],function(a){var b=function(d){d&&c.extend(this,d),this.vendorPrefix=a,this.vendorPrefix=="Moz"||this.vendorPrefix==""?this.transitionEndEvent="transitionend":this.vendorPrefix=="ms"?this.transitionEndEvent="MSTransitionEnd":this.transitionEndEvent=this.vendorPrefix+"TransitionEnd"},d=function(){};return b.extend=function(a,e){var f=function(){b.apply(this,arguments)};return c.extend(f,b),d.prototype=b.prototype,f.prototype=new d,a&&c.extend(f.prototype,a),e&&c.extend(f,e),f.prototype.constructor=f,f.__super__=b.prototype,f},b}),h("effects/NoEffect",["effects/Effect"],function(a){var b=a.extend();return b.prototype.play=function(a,b,c,d){b&&b.css("visibility","visible"),c.call(d)},b}),h("effects/SlideEffect",["effects/Effect"],function(a){var b=a.extend({direction:"left",fromViewTransitionProps:{duration:.4,easing:"ease-out",delay:0},toViewTransitionProps:{duration:.4,easing:"ease-out",delay:0},play:function(a,b,c,d){var e,f=this,g=0,h,i=f.vendorPrefix==""?"transform":["-"+f.vendorPrefix,"-","transform"].join(""),j=f.vendorPrefix==""?"transition":["-"+f.vendorPrefix,"-","transition"].join(""),k=function(a){g>=0&&(g--,a.target.style[j]="",a.target.style[i]="",b&&b[0]==a.target&&b.css("left",0),g==0&&c&&(e&&clearTimeout(e),c.call(d)))};a&&(g++,a.one(f.transitionEndEvent,k),a.css("left",0),a.css(j,[i," ",f.fromViewTransitionProps.duration,"s ",f.fromViewTransitionProps.easing," ",f.fromViewTransitionProps.delay,"s"].join(""))),b&&(g++,b.one(f.transitionEndEvent,k),b.css("left",f.direction=="left"?d.$el.width():-d.$el.width()),b.css(j,[i," ",f.toViewTransitionProps.duration,"s ",f.toViewTransitionProps.easing," ",f.toViewTransitionProps.delay,"s"].join("")),b.css("visibility","visible"));if(a||b)d.$el.css("width"),h="translateX("+(f.direction=="left"?-d.$el.width():d.$el.width())+"px)";var l=Math.max(f.fromViewTransitionProps.duration,f.toViewTransitionProps.duration)+Math.max(f.fromViewTransitionProps.delay,f.toViewTransitionProps.delay);a&&b?a[0].style[i]=b[0].style[i]=h:b?b[0].style[i]=h:a&&(a[0].style[i]=h)}});return b}),h("StackNavigator",["effects/SlideEffect"],function(a){var b=function(a,b){a.__backStackRendered__?a.$el.css({visibility:"hidden"}):(a.stackNavigator=b,typeof a.destructionPolicy=="undefined"&&(a.destructionPolicy="auto"),a.$el.css({position:"absolute",visibility:"hidden",overflow:"hidden",width:"100%",height:"100%"})),b.$el.append(a.el),a.__backStackRendered__||(a.render.call(a),a.__backStackRendered__=!0)},f=function(c,d,e){b(d.instance,this),this.viewsStack.push(d),e=e||this.defaultPushTransition||(this.defaultPushTransition=new a({direction:"left"})),e.play(c?c.instance.$el:null,d.instance.$el,function(){this.activeView=d.instance,d.instance.$el.trigger("viewActivate"),c&&(c.instance.$el.trigger("viewDeactivate"),c.instance.destructionPolicy=="never"?c.instance.$el.detach():(c.instance.remove(),c.instance=null)),this.trigger("viewChanged")},this)},g=function(c,d,e){this.viewsStack.pop();if(d){if(!d.instance){var f=d.viewClass;d.instance=new f(d.options)}b(d.instance,this)}e=e||this.defaultPopTransition||(this.defaultPopTransition=new a({direction:"right"})),e.play(c.instance.$el,d?d.instance.$el:null,function(){d?(this.activeView=d.instance,d.instance.$el.trigger("viewActivate")):this.activeView=null,c.instance.$el.trigger("viewDeactivate"),c.instance.remove(),c.instance=null,this.trigger("viewChanged")},this)},h=e.View.extend({viewsStack:null,activeView:null,defaultPushTransition:null,defaultPopTransition:null,events:{viewActivate:"proxyActivationEvents",viewDeactivate:"proxyActivationEvents"},proxyActivationEvents:function(a){this.trigger(a.type,a)},initialize:function(a){this.$el.css({overflow:"hidden"}),this.viewsStack=[]},pushView:function(a,b,e){var g,h,i=typeof a!="function",j=c.last(this.viewsStack);g=i?a:new a(b),h={instance:g,viewClass:g.constructor,options:b};var k=d.Event("viewChanging",{action:"push",fromViewClass:j?j.viewClass:null,fromView:j?j.instance:null,toViewClass:h.viewClass,toView:h.instance});return this.trigger(k.type,k),k.isDefaultPrevented()?null:(f.call(this,j,h,e),g)},popView:function(a){var b,c;this.viewsStack.length>0&&(c=this.viewsStack[this.viewsStack.length-1]),this.viewsStack.length>1&&(b=this.viewsStack[this.viewsStack.length-2]);var e=d.Event("viewChanging",{action:"pop",fromViewClass:c?c.viewClass:null,fromView:c?c.instance:null,toViewClass:b?b.viewClass:null,toView:b?b.instance:null});this.trigger(e.type,e);if(!e.isDefaultPrevented()){var f=c.instance;return g.call(this,c,b,a),f}return null},popAll:function(a){if(this.viewsStack.length>0){var b;this.viewsStack.length>0&&(b=this.viewsStack[this.viewsStack.length-1]);var c=d.Event("viewChanging",{action:"popAll",fromViewClass:b?b.viewClass:null,fromView:b?b.instance:null,toViewClass:null,toView:null});this.trigger(c.type,c),c.isDefaultPrevented()||(this.viewsStack.splice(0,this.viewsStack.length-1),g.call(this,b,null,a))}return null},replaceView:function(a,b,c){if(this.viewsStack.length>0){var e,g,h=typeof a!="function",i=this.viewsStack[this.viewsStack.length-1];e=h?a:new a(b),g={instance:e,viewClass:e.constructor,options:b};var j=d.Event("viewChanging",{action:"replace",fromViewClass:i.viewClass,fromView:i.instance,toViewClass:g.viewClass,toView:g.instance});this.trigger(j.type,j);if(!j.isDefaultPrevented())return this.viewsStack.pop(),f.call(this,i,g,c),e}return null},replaceAll:function(a,b,c){if(this.viewsStack.length>0){var e,g,h=typeof a!="function",i=this.viewsStack[this.viewsStack.length-1];e=h?a:new a(b),g={instance:e,viewClass:e.constructor,options:b};var j=d.Event("viewChanging",{action:"replaceAll",fromViewClass:i.viewClass,fromView:i.instance,toViewClass:g.viewClass,toView:g.instance});this.trigger(j.type,j);if(!j.isDefaultPrevented())return this.viewsStack.splice(0,this.viewsStack.length),f.call(this,i,g,c),e}return null}});return h}),h("effects/FadeEffect",["effects/Effect"],function(a){var b=a.extend({fromViewTransitionProps:{duration:.4,easing:"linear",delay:.1},toViewTransitionProps:{duration:.4,easing:"linear",delay:.1},play:function(a,b,c,d){var e=this,f,g=0,h=e.vendorPrefix==""?"transition":["-"+e.vendorPrefix.toLowerCase(),"-","transition"].join(""),i=function(a){g>=0&&(g--,a.target.style[h]="",g==0&&c&&(f&&clearTimeout(f),c.call(d)))};a&&(g++,a.one(e.transitionEndEvent,i),a.css(h,["opacity ",e.fromViewTransitionProps.duration,"s ",e.fromViewTransitionProps.easing," ",e.fromViewTransitionProps.delay,"s"].join(""))),b&&(g++,b.one(e.transitionEndEvent,i),b.css("opacity",0),b.css(h,["opacity ",e.toViewTransitionProps.duration,"s ",e.toViewTransitionProps.easing," ",e.toViewTransitionProps.delay,"s"].join("")),b.css("visibility","visible")),d.$el.css("width");var j=Math.max(e.fromViewTransitionProps.duration,e.toViewTransitionProps.duration)+Math.max(e.fromViewTransitionProps.delay,e.toViewTransitionProps.delay);f=setTimeout(function(){g>0&&(g=-1,console.log("Warning "+e.transitionEndEvent+" didn't trigger in expected time!"),b&&(b.off(e.transitionEndEvent,i),b.css(h,"")),a&&(a.off(e.transitionEndEvent,i),a.css(h,"")),c.call(d))},j*1.5*1e3),b&&b.css("opacity",1),a&&a.css("opacity",0)}});return b}),h("BackStack",["StackNavigator","effects/Effect","effects/NoEffect","effects/SlideEffect","effects/FadeEffect"],function(a,c,d,e,f){return b.StackNavigator=a,b.Effect=c,b.NoEffect=d,b.SlideEffect=e,b.FadeEffect=f,b}),b})