(function(a,b){typeof exports!="undefined"?b(a,exports,require("underscore"),require("jquery"),require("Backbone")):typeof define=="function"&&define.amd?define(["underscore","jquery","Backbone","exports"],function(c,d,e,f){a.BackStack=b(a,f,c,d,e)}):a.BackStack=b(a,{},a._,a.jQuery||a.Zepto||a.ender,a.Backbone)})(this,function(a,b,c,d,e){var f,g,h;return function(a){function j(a,b){if(a&&a.charAt(0)==="."&&b){b=b.split("/"),b=b.slice(0,b.length-1),a=b.concat(a.split("/"));var c,d;for(c=0;d=a[c];c++)if(d===".")a.splice(c,1),c-=1;else if(d==="..")if(c!==1||a[2]!==".."&&a[0]!=="..")c>0&&(a.splice(c-1,2),c-=2);else break;a=a.join("/")}return a}function k(b,c){return function(){return i.apply(a,d.call(arguments,0).concat([b,c]))}}function l(a){return function(b){return j(b,a)}}function m(a){return function(c){b[a]=c}}function n(d){if(c.hasOwnProperty(d)){var f=c[d];delete c[d],e.apply(a,f)}return b[d]}function o(a,b){var c,d,e=a.indexOf("!");return e!==-1?(c=j(a.slice(0,e),b),a=a.slice(e+1),d=n(c),d&&d.normalize?a=d.normalize(a,l(b)):a=j(a,b)):a=j(a,b),{f:c?c+"!"+a:a,n:a,p:d}}var b={},c={},d=[].slice,e,i;if(typeof h=="function")return;e=function(d,e,f,g){var h=[],i,j,l,p,q,r;g||(g=d);if(typeof f=="function"){!e.length&&f.length&&(e=["require","exports","module"]);for(p=0;p<e.length;p++){r=o(e[p],g),l=r.f;if(l==="require")h[p]=k(d);else if(l==="exports")h[p]=b[d]={},i=!0;else if(l==="module")j=h[p]={id:d,uri:"",exports:b[d]};else if(b.hasOwnProperty(l)||c.hasOwnProperty(l))h[p]=n(l);else if(r.p)r.p.load(r.n,k(g,!0),m(l),{}),h[p]=b[l];else throw d+" missing "+l}q=f.apply(b[d],h),d&&(j&&j.exports!==a?b[d]=j.exports:i||(b[d]=q))}else d&&(b[d]=f)},f=i=function(b,c,d,f){return typeof b=="string"?n(o(b,c).f):(b.splice||(c.splice?(b=c,c=arguments[2]):b=[]),f?e(a,b,c,d):setTimeout(function(){e(a,b,c,d)},15),i)},i.config=function(){return i},g||(g=i),h=function(a,b,d){b.splice||(d=b,b=[]),h.unordered?c[a]=[a,b,d]:e(a,b,d)},h.amd={jQuery:!0}}(),h("almond",function(){}),h("effects/vendorPrefix",[],function(){var a,b=/^(Moz|Webkit|Khtml|O|ms|Icab)(?=[A-Z])/,c=document.getElementsByTagName("script")[0];if("WebkitOpacity"in c.style)a="Webkit";else if("KhtmlOpacity"in c.style)a="Khtml";else for(var d in c.style)if(b.test(d)){a=d.match(b)[0];break}return a.toLowerCase()||""}),h("effects/Effect",["effects/vendorPrefix"],function(a){var b=function(d){d&&c.extend(this,d),this.vendorPrefix=a,this.vendorPrefix=="moz"||this.vendorPrefix==""?this.transitionEndEvent="transitionend":this.vendorPrefix=="ms"?this.transitionEndEvent="MSTransitionEnd":this.transitionEndEvent=this.vendorPrefix+"TransitionEnd"},d=function(){};return b.extend=function(a,e){var f=function(){b.apply(this,arguments)};return c.extend(f,b),d.prototype=b.prototype,f.prototype=new d,a&&c.extend(f.prototype,a),e&&c.extend(f,e),f.prototype.constructor=f,f.__super__=b.prototype,f},b}),h("effects/NoEffect",["effects/Effect"],function(a){var b=a.extend();return b.prototype.play=function(a,b,c,d){b&&b.css("visibility","visible"),c.call(d)},b}),h("effects/SlideEffect",["effects/Effect"],function(a){var b=a.extend({direction:"left",fromViewTransitionProps:{duration:.4,easing:"ease-out",delay:0},toViewTransitionProps:{duration:.4,easing:"ease-out",delay:0},play:function(a,b,c,e){var f,g=this,h=0,i,j=g.vendorPrefix==""?"transform":["-"+g.vendorPrefix,"-","transform"].join(""),k=g.vendorPrefix==""?"transition":["-"+g.vendorPrefix,"-","transition"].join(""),l=function(a){if(h>=0){h--;var g=d(a.target);g.css(j,""),g.css(k,""),b&&b[0]==a.target&&b.css("left",0),h==0&&c&&(f&&clearTimeout(f),c.call(e))}};a&&(h++,a.one(g.transitionEndEvent,l),a.css("left",0),a.css(k,[j," ",g.fromViewTransitionProps.duration,"s ",g.fromViewTransitionProps.easing," ",g.fromViewTransitionProps.delay,"s"].join(""))),b&&(h++,b.one(g.transitionEndEvent,l),b.css("left",g.direction=="left"?e.$el.width():-e.$el.width()),b.css(k,[j," ",g.toViewTransitionProps.duration,"s ",g.toViewTransitionProps.easing," ",g.toViewTransitionProps.delay,"s"].join("")),b.css("visibility","visible"));if(a||b)e.$el.css("width"),i="translateX("+(g.direction=="left"?-e.$el.width():e.$el.width())+"px)";var m=Math.max(g.fromViewTransitionProps.duration,g.toViewTransitionProps.duration)+Math.max(g.fromViewTransitionProps.delay,g.toViewTransitionProps.delay);f=setTimeout(function(){h>0&&(h=-1,console.log("Warning "+g.transitionEndEvent+" didn't trigger in expected time!"),b&&(b.off(g.transitionEndEvent,l),b.css(k,""),b.css(j,""),b.css("left",0)),a&&(a.off(g.transitionEndEvent,l),a.css(k,""),a.css(j,"")),c.call(e))},m*1.5*1e3);var n;a&&b?n=a.add(b):b?n=b:a&&(n=a),n&&n.css(j,i)}});return b}),h("StackNavigator",["effects/SlideEffect"],function(a){var b=function(a,b){a.__backStackRendered__?a.$el.css({visibility:"hidden"}):(a.stackNavigator=b,typeof a.destructionPolicy=="undefined"&&(a.destructionPolicy="auto"),a.$el.css({position:"absolute",visibility:"hidden",overflow:"hidden",width:"100%",height:"100%"})),b.$el.append(a.el),a.__backStackRendered__||(a.render.call(a),a.__backStackRendered__=!0)},d=function(a,b,d){return c.extend({type:a,cancelable:c.isUndefined(d)?!1:d,preventDefault:function(){this.cancelable&&(this.isDefaultPrevented=function(){return!0})},isDefaultPrevented:function(){return!1},trigger:function(a){return a.trigger(this.type,this),this}},b)},f=function(e,f,g,h){b(f.instance,this),h=h||this.defaultPushTransition||(this.defaultPushTransition=new a({direction:"left"})),h.play(e?e.instance.$el:null,f.instance.$el,function(){var a=g>0?this.viewsStack.splice(this.viewsStack.length-g,g):e?[e]:null;c.each(a,function(a){d("viewDeactivate",{target:a.instance}).trigger(a.instance),a.instance.destructionPolicy=="never"?a.instance.$el.detach():(a.instance.remove(),a.instance=null)},this),this.viewsStack.push(f),this.activeView=f.instance,d("viewActivate",{target:f.instance}).trigger(f.instance),d("viewChanged",{target:this}).trigger(this)},this)},g=function(e,f,g,h){f&&(f.instance=f.instance?f.instance:new f.viewClass(f.options),b(f.instance,this)),h=h||this.defaultPopTransition||(this.defaultPopTransition=new a({direction:"right"})),h.play(e.instance.$el,f?f.instance.$el:null,function(){var a=this.viewsStack.splice(this.viewsStack.length-g,g);c.each(a,function(a){d("viewDeactivate",{target:a.instance}).trigger(a.instance),a.instance.destructionPolicy=="never"?a.instance.$el.detach():(a.instance.remove(),a.instance=null)},this),f?(this.activeView=f.instance,d("viewActivate",{target:f.instance}).trigger(f.instance)):this.activeView=null,d("viewChanged",{target:this}).trigger(this)},this)},h=e.View.extend({viewsStack:null,activeView:null,defaultPushTransition:null,defaultPopTransition:null,initialize:function(a){this.$el.css({overflow:"hidden"}),this.viewsStack=[],a.popTransition&&(this.defaultPopTransition=a.popTransition),a.pushTransition&&(this.defaultPushTransition=a.pushTransition)},pushView:function(a,b,e){var g=c.last(this.viewsStack),h=c.isFunction(a)?new a(b):a,i={instance:h,viewClass:h.constructor,options:b},j=d("viewChanging",{action:"push",fromViewClass:g?g.viewClass:null,fromView:g?g.instance:null,toViewClass:i.viewClass,toView:i.instance},!0).trigger(this);return j.isDefaultPrevented()?null:(f.call(this,g,i,0,e),h)},popView:function(a){if(this.viewsStack.length==0)throw new Error("Popping from an empty stack!");var b=c.last(this.viewsStack),e=this.viewsStack.length>1?this.viewsStack[this.viewsStack.length-2]:null,f=d("viewChanging",{action:"pop",fromViewClass:b.viewClass,fromView:b.instance,toViewClass:e?e.viewClass:null,toView:e?e.instance:null},!0).trigger(this);if(f.isDefaultPrevented())return;g.call(this,b,e,1,a)},popAll:function(a){if(this.viewsStack.length==0)throw new Error("Popping from an empty stack!");var b=c.last(this.viewsStack),e=d("viewChanging",{action:"popAll",fromViewClass:b.viewClass,fromView:b.instance,toViewClass:null,toView:null},!0).trigger(this);if(e.isDefaultPrevented())return;g.call(this,b,null,this.viewsStack.length,a)},replaceView:function(a,b,e){if(this.viewsStack.length==0)throw new Error("Replacing on an empty stack!");var g=c.last(this.viewsStack),h=c.isFunction(a)?new a(b):a,i={instance:h,viewClass:h.constructor,options:b},j=d("viewChanging",{action:"replace",fromViewClass:g.viewClass,fromView:g.instance,toViewClass:i.viewClass,toView:i.instance},!0).trigger(this);return j.isDefaultPrevented()?null:(f.call(this,g,i,1,e),h)},replaceAll:function(a,b,e){if(this.viewsStack.length==0)throw new Error("Replacing on an empty stack!");var g=c.last(this.viewsStack),h=c.isFunction(a)?new a(b):a,i={instance:h,viewClass:h.constructor,options:b},j=d("viewChanging",{action:"replaceAll",fromViewClass:g.viewClass,fromView:g.instance,toViewClass:i.viewClass,toView:i.instance},!0).trigger(this);return j.isDefaultPrevented()?null:(f.call(this,g,i,this.viewsStack.length,e),h)}});return h}),h("effects/FadeEffect",["effects/Effect"],function(a){var b=a.extend({fromViewTransitionProps:{duration:.4,easing:"linear",delay:.1},toViewTransitionProps:{duration:.4,easing:"linear",delay:.1},play:function(a,b,c,e){var f=this,g,h=0,i=f.vendorPrefix==""?"transition":["-"+f.vendorPrefix.toLowerCase(),"-","transition"].join(""),j=function(a){h>=0&&(h--,d(a.target).css(i,""),h==0&&c&&(g&&clearTimeout(g),c.call(e)))};a&&(h++,a.one(f.transitionEndEvent,j),a.css(i,["opacity ",f.fromViewTransitionProps.duration,"s ",f.fromViewTransitionProps.easing," ",f.fromViewTransitionProps.delay,"s"].join(""))),b&&(h++,b.one(f.transitionEndEvent,j),b.css("opacity",0),b.css(i,["opacity ",f.toViewTransitionProps.duration,"s ",f.toViewTransitionProps.easing," ",f.toViewTransitionProps.delay,"s"].join("")),b.css("visibility","visible")),e.$el.css("width");var k=Math.max(f.fromViewTransitionProps.duration,f.toViewTransitionProps.duration)+Math.max(f.fromViewTransitionProps.delay,f.toViewTransitionProps.delay);g=setTimeout(function(){h>0&&(h=-1,console.log("Warning "+f.transitionEndEvent+" didn't trigger in expected time!"),b&&(b.off(f.transitionEndEvent,j),b.css(i,"")),a&&(a.off(f.transitionEndEvent,j),a.css(i,"")),c.call(e))},k*1.5*1e3),b&&b.css("opacity",1),a&&a.css("opacity",0)}});return b}),h("BackStack",["StackNavigator","effects/Effect","effects/NoEffect","effects/SlideEffect","effects/FadeEffect"],function(a,c,d,e,f){return b.StackNavigator=a,b.Effect=c,b.NoEffect=d,b.SlideEffect=e,b.FadeEffect=f,b}),b})